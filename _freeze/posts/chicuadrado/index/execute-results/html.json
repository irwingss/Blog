{
  "hash": "a491b381d9d5e57b3c10e84b7949d1f4",
  "result": {
    "markdown": "---\ntitle: \"Test de Independencia de Chi cuadrado usando R\"\nauthor: \"Irwing S. Saldaña\"\ndate: \"2021-07-22\"\ncategories: [dataviz, R, Estadística]\nimage: \"img/portada.png\"\n---\n\n\nLa **prueba de chi cuadrado** es una prueba estadística sencilla que puede ser usada cuando se tienen datos de recuento de ocurrencias de categorías. El análisis puede ser definido como una:\n\n-   **Prueba de diferencia de conteos:** para identificar si los conteos observados en las categorías de una variable son estadísticamente diferentes entre sí.\n\n-   **Prueba de diferencia de conteos con probabilidades específicas:** identifica si los conteos observados en las categorías de una variable son estadísticamente diferentes entre sí dado que cada evento tiene una probabilidad de ocurrencia definida. Se debe especificar las probabilidades como un vector en el argumento `p` de la función. Para fines de este tutorial no veremos el detalle de esta prueba.\n\n-   **Prueba de independencia de dos factores:** identifica a nivel estadístico si las categorías de dos variables están asociadas o son independientes.\n\nEn R, la función nativa básica para el cálculo de esta prueba es:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Debemos tener en cuenta que la prueba tiene \n# la corrección de Yates activa por defecto. \n# Debemos modificar el argumento correct si \n# deseamos activarla o desactivarla.\nchisq.test(x, correct = TRUE)\n```\n:::\n\n\n<br>\n\n<br>\n\n## **Video explicativo**\n\n\n```{=html}\n<div style=\"position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;\">\n  <iframe src=\"https://www.youtube.com/embed/KTSBu6CdJbg?autoplay=0\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;\" allowfullscreen title=\"Video explicativo\"></iframe>\n</div>\n```\n\n<br>\n\n### **Librarías de Trabajo**\n\nEl siguiente código sirve para instalar las librerías a usar:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"tidyverse\")\ninstall.packages(\"corrplot\")\ninstall.packages(\"vcd\")\ninstall.packages(\"DescTools\")\ninstall.packages(\"CGPfunctions\")\n```\n:::\n\n\nAhora, activa las librerías:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(corrplot)\nlibrary(vcd)\nlibrary(DescTools)\nlibrary(CGPfunctions)\n```\n:::\n\n\n## **Tablas de ejemplo**\n\nTrabajaremos con dos tipos de tablas para realizar los ejemplos:\n\n-   Tabla de contingencia de dos factores.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Tabla de contingencia de dos factores. \n# Nivel (de 0 al 3) vs Grado (de 1 al 5).\nurl1 <- \"https://raw.githubusercontent.com/irwingss/ArchivosCuestionarios/main/Matriz%20Grados.csv\"\ngrados <- read.csv(url1)\n\n# Visualizar\ngrados\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  Grado1 Grado2 Grado3 Grado4 Grado5\n1   2900    392    932   1812   2854\n2    522    421    574    917   1247\n3   5678   8126   1171   1478   2040\n4   3719   2975   2811   1704   2244\n```\n:::\n:::\n\n\n-   Tabla larga con los valores de ocurrencia las categorías.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Tabla larga con los valores de ocurrencia las categorías\nurl2 <- \"https://raw.githubusercontent.com/irwingss/ArchivosCuestionarios/main/tabla_larga_chi_cuadrado.csv\"\ndataMejora <- read.csv(url2)\n\n# Visualizar primeras 20 filas\nhead(dataMejora,20)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     treatment  improvement\n1      treated     improved\n2      treated     improved\n3  not-treated     improved\n4      treated     improved\n5      treated not-improved\n6      treated not-improved\n7  not-treated not-improved\n8      treated not-improved\n9  not-treated     improved\n10     treated     improved\n11 not-treated     improved\n12 not-treated not-improved\n13 not-treated not-improved\n14 not-treated not-improved\n15 not-treated     improved\n16 not-treated     improved\n17     treated     improved\n18     treated     improved\n19 not-treated not-improved\n20 not-treated not-improved\n```\n:::\n:::\n\n\n-   Como dato adicional, si deseas transformar una matriz de contingencia a tabla larga (e.g., convirtamos `grados` en tabla larga), puedes usar el siguiente código:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Si deseas reutilizar este código, solo cambia las etiquetas: \n# grados y categoría por el nombre de las dos factores de tu interés\ngrados%>%\n  as.data.frame() %>% \n  rownames_to_column() %>%            \n  gather(Grados, valores, -rowname) %>% \n  rowwise() %>%                       \n  mutate(valores = list(1:valores)) %>%  \n  unnest(valores) %>%                   \n  select(-valores) %>% \n  rename(Nivel = rowname) -> gradosLarga\n\n# Visualizar el tibble\nView(gradosLarga)\n```\n:::\n\n\n# **Chi cuadrado para conteos**\n\nSe desea evaluar si existe diferencia entre la cantidad (recuento) de las personas inscritas en todos los grados para el primer nivel de la tabla `grados` podemos hacer un test de chi cuadrado sencillo:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Separar la base de datos de grados\ninscritos <- grados[1,]\ninscritos\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  Grado1 Grado2 Grado3 Grado4 Grado5\n1   2900    392    932   1812   2854\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Realizar la prueba chi cuadrado\nresX2 <- chisq.test(inscritos, correct = F)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Inspeccionar los valores esperados\nresX2$expected\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1778 1778 1778 1778 1778\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Inspeccionar los valores observados\nresX2$observed\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 2900  392  932 1812 2854\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Ver los resultados de la prueba\nresX2\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tChi-squared test for given probabilities\n\ndata:  inscritos\nX-squared = 2842.8, df = 4, p-value < 2.2e-16\n```\n:::\n:::\n\n\nLas hipótesis a contrastar son:\n\n-   H0: no existe diferencia entre los recuentos de las personas inscritos en los grados.\n\n-   Ha: existe diferencia entre los recuentos de las personas inscritos en los grados.\n\nEl **p-valor \\< 2.2e-16** es menor a el p-valor crítico de 0.05, por lo que **se rechaza H0**, y decimos que existe diferencia entre los recuentos de las personas inscritas en los diferentes grados evaluados.\n\n# **Chi cuadrado de independencia de dos factores**\n\nEs el uso más típico de la prueba es el contrastar si los niveles de dos factores, es decir, de dos variables categóricas, son independientes o existe evidencia estadística de asociación entre ellas.\n\nLas hipótesis a contrastar son:\n\n-   H0: las variables son independientes.\n\n-   Ha: las variables son dependientes.\n\nVeamos si existen diferencias entre los factores en los dos ejemplos cargados\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Para matrices de contingencia (niveles vs grados)\nchisq.test(grados, correct = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tPearson's Chi-squared test\n\ndata:  grados\nX-squared = 8885.1, df = 12, p-value < 2.2e-16\n```\n:::\n:::\n\n\nEl **p-valor \\< 2.2e-16** es menor a el p-valor crítico de 0.05, por lo que **se rechaza H0**, y decimos que existe dependencia entre las variables niveles y grados.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Para tablas largas sin transformar \n# (treatment vs improvement)\nwith(dataMejora, chisq.test(treatment, improvement, correct = FALSE))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tPearson's Chi-squared test\n\ndata:  treatment and improvement\nX-squared = 5.5569, df = 1, p-value = 0.01841\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Para tablas largas convertidas a matrices de \n# contingencia (treatment vs improvement)\nmatrizDesdeTablaLarga <- table(dataMejora) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nchisq.test(matrizDesdeTablaLarga, correct = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tPearson's Chi-squared test\n\ndata:  matrizDesdeTablaLarga\nX-squared = 5.5569, df = 1, p-value = 0.01841\n```\n:::\n:::\n\n\nEl **p-valor \\< 0.01841** es menor a el p-valor crítico de 0.05, por lo que **se rechaza H0**, y decimos que la mejora (improvement) y el tratamiento (treatment) son dependientes.\n\n## **Corrección de Yates**\n\nEs buena práctica realizar la prueba de Chi cuadrado sin corrección, observar los valores esperados y detectar si alguno de ellos es menor a 5. Si eso ocurre, se debe aplicar la corrección de Yates para corregir el cálculo del p-valor.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Para ver los valores esperados se tiene que\n#  guardar la prueba como un objeto en el ambiente\nresGrados <- chisq.test(grados, correct = FALSE)\nresMejora <- with(dataMejora, chisq.test(treatment, improvement, correct = FALSE))\n\n# Luego, se inspecciona el objeto con $expected\nresGrados$expected\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n       Grado1   Grado2    Grado3    Grado4    Grado5\n[1,] 2559.941 2379.214 1095.9481 1180.4207 1674.4760\n[2,] 1059.971  985.139  453.7891  488.7659  693.3348\n[3,] 5325.196 4949.246 2279.7939 2455.5141 3483.2492\n[4,] 3873.891 3600.401 1658.4690 1786.2992 2533.9400\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nresMejora$expected\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             improvement\ntreatment     improved not-improved\n  not-treated 31.95238     23.04762\n  treated     29.04762     20.95238\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Incluso convertir esto a una prueba lógica\n# TRUE significa que el valor es mayor de 5\nresGrados$expected > 5\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     Grado1 Grado2 Grado3 Grado4 Grado5\n[1,]   TRUE   TRUE   TRUE   TRUE   TRUE\n[2,]   TRUE   TRUE   TRUE   TRUE   TRUE\n[3,]   TRUE   TRUE   TRUE   TRUE   TRUE\n[4,]   TRUE   TRUE   TRUE   TRUE   TRUE\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nresMejora$expected > 5\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             improvement\ntreatment     improved not-improved\n  not-treated     TRUE         TRUE\n  treated         TRUE         TRUE\n```\n:::\n:::\n\n\nEn ambos casos presentados no es necesario realizar la corrección de Yates.\n\n## **Categorías que más contribuyen al score de la prueba**\n\nSe puede conocer cuál es el aporte al score de Chi Cuadrado de cada categoría en las dos variables contrastadas visualizando los **residuales** (diferencia entre el valor esperado y el observado) en cada casilla.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Resultados textuales\nround(resGrados$residuals, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      Grado1  Grado2  Grado3  Grado4  Grado5\n[1,]   6.721 -40.741  -4.952  18.383  28.825\n[2,] -16.524 -17.974   5.643  19.370  21.027\n[3,]   4.835  45.156 -23.222 -19.727 -24.454\n[4,]  -2.489 -10.423  28.301  -1.947  -5.760\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Gráfica de contribución\ncorrplot::corrplot(resGrados$residuals, is.cor = FALSE, \n         method = \"color\", addgrid.col=F,\n         tl.col = \"black\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n## **Gráficos de Mosaico**\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Gráfico de mosaico simple\nvcd::mosaic(~ Nivel, data=gradosLarga)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n\n```{.r .cell-code}\nvcd::mosaic(~ Grados, data=gradosLarga)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-22-2.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Gráfico de mosaico para ambas variables\nvcd::mosaic(Grados~ Nivel, data=gradosLarga)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n\n```{.r .cell-code}\nvcd::doubledecker(Grados~Nivel, data=gradosLarga)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-23-2.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Gráfico de mosaico para ambas variables sombreado por su nivel de aporte\nvcd::mosaic(~ Nivel  + Grados,\n            direction = c(\"v\", \"h\"),\n            data = gradosLarga,\n            shade = TRUE, \n            spacing = vcd::spacing_equal(sp = unit(0.3, \"lines\")))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\n## **Nivel de asociación**\n\nUna vez que determinamos que existe dependencia entre las dos variables es posible que queramos conocer el nivel de dicha dependencia o asociación. Para este fin recurriremos a el `coeficiente de contingencia` o a índices como la `V de Cramer`. En particular, se recomienda el uso del coeficiente de contingencia para tablas más grandes que 5x5, mientras que para tablas pequeñas la V de Cramer es el indicador de asociación más popular. En R hay varias funciones que entregan estos resultados, aquí revisaremos dos de ellas.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Para matrices de contingencia\nvcd::assocstats(as.matrix(grados))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                    X^2 df P(> X^2)\nLikelihood Ratio 9401.3 12        0\nPearson          8885.1 12        0\n\nPhi-Coefficient   : NA \nContingency Coeff.: 0.408 \nCramer's V        : 0.258 \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nDescTools::Assocs(as.matrix(grados))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Para tablas largas, esta se debe convertir a \n# matriz de contingencia con la funcion table()\nvcd::assocstats(table(dataMejora))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                    X^2 df P(> X^2)\nLikelihood Ratio 5.6275  1 0.017681\nPearson          5.5569  1 0.018408\n\nPhi-Coefficient   : 0.23 \nContingency Coeff.: 0.224 \nCramer's V        : 0.23 \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nDescTools::Assocs(table(dataMejora))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                       estimate  lwr.ci  upr.ci\nContingency Coeff.       0.2242       -       -\nCramer V                 0.2301  0.0324  0.4213\nKendall Tau-b           -0.2301 -0.4152 -0.0449\nGoodman Kruskal Gamma   -0.4448 -0.7672 -0.1225\nStuart Tau-c            -0.2268 -0.4095 -0.0440\nSomers D C|R            -0.2273 -0.4104 -0.0441\nSomers D R|C            -0.2329 -0.4208 -0.0449\nPearson Correlation     -0.2301 -0.4039 -0.0402\nSpearman Correlation    -0.2301 -0.4039 -0.0402\nLambda C|R               0.0682  0.0000  0.3871\nLambda R|C               0.1800  0.0000  0.4572\nLambda sym               0.1277  0.0000  0.3861\nUncertainty Coeff. C|R   0.0394 -0.0246  0.1035\nUncertainty Coeff. R|C   0.0387 -0.0243  0.1017\nUncertainty Coeff. sym   0.0391 -0.0244  0.1026\nMutual Information       0.0387       -       -\n```\n:::\n:::\n\n\nDado el tamaño de las matrices de contingencia, tomaremos como valor de interés a la V de Cramer. El valor va de 0, asociación nula, a 1, máxima dependencia. Para el estudio de niveles vs grados, se obtiene `v = 0.25`, por lo que podemos concluir que la asociación entre las variables es baja. Lo mismo ocurre para el estudio de la asociación entre el tratamiento (treatment) y la mejora (improvement) con `v = 0.23`.\n\n## **Gráficos de recuentos**\n\nLa librería `CGPfunctions` provee una forma muy sencilla de graficar los conteos usando una tabla larga de datos con ambas variables categóricas en ella.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Gráfico para el estudio de Grados vs Nivel\nCGPfunctions::PlotXTabs(gradosLarga, Grados, Nivel)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nPlotted dataset gradosLarga variables Grados by Nivel\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-29-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nCGPfunctions::PlotXTabs(gradosLarga, Nivel, Grados)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nPlotted dataset gradosLarga variables Nivel by Grados\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-30-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Gráfico para el estudio de treatment vs improvement\nCGPfunctions::PlotXTabs(dataMejora, treatment, improvement)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nPlotted dataset dataMejora variables treatment by improvement\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-31-1.png){width=672}\n:::\n:::\n\n\nPuedes cambiar el argumento `plottype =` para cambiar rápidamente la forma del gráfico:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Barras apiladas\nCGPfunctions::PlotXTabs(gradosLarga, Grados, Nivel, plottype=\"stack\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nPlotted dataset gradosLarga variables Grados by Nivel\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Barras porcentuales\nCGPfunctions::PlotXTabs(gradosLarga, Grados, Nivel, plottype=\"percent\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nPlotted dataset gradosLarga variables Grados by Nivel\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-33-1.png){width=672}\n:::\n:::\n\n\n<br>\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}